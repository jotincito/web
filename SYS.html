<html><head><base href="." /><title>Sistema de Facturación - Hiperbárica Morel</title><meta charset="UTF-8">
<style>
  :root {
    --primary: #2C3E50;
    --secondary: #3498DB;
    --accent: #E74C3C;
    --light: #ECF0F1;
    --dark: #2C3E50;
    --bg: #f5f6fa;
    --text: #2C3E50;
    --card-bg: white;
  }

  [data-theme="dark"] {
    --bg: #1a1a1a;
    --text: #ffffff;
    --card-bg: #2d2d2d;
    --primary: #1a1a1a;
    --secondary: #3498DB;
    --accent: #E74C3C;
    --light: #ECF0F1;
    --dark: #f5f6f0;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
  }

  body {
    background: var(--bg);
    color: var(--text);
  }

  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    height: 100%;
    width: 250px;
    background: var(--primary);
    padding: 20px;
    transition: all 0.3s;
  }

  .sidebar .logo {
    color: white;
    font-size: 24px;
    text-align: center;
    margin-bottom: 30px;
  }

  .sidebar .logo img {
    width: 150px;
    height: auto;
    display: block;
    margin: 0 auto 15px;
  }

  .sidebar .menu a {
    display: block;
    color: white;
    text-decoration: none;
    padding: 12px 15px;
    margin: 8px 0;
    border-radius: 8px;
    transition: 0.3s;
  }

  .sidebar .menu a:hover {
    background: var(--secondary);
  }

  .main-content {
    margin-left: 250px;
    padding: 20px;
  }

  .header {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }

  .stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    color: var(--text);
  }

  .chart-container {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }

  .invoice-form {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    color: var(--dark);
  }

  .form-group input, .form-group select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 5px;
  }

  .btn {
    background: var(--secondary);
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: 0.3s;
  }

  .btn:hover {
    background: var(--primary);
  }

  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
  }

  .modal-content {
    background: var(--card-bg);
    width: 80%;
    max-width: 600px;
    margin: 50px auto;
    padding: 20px;
    border-radius: 10px;
    position: relative;
  }

  .invoice-preview {
    background: var(--card-bg);
    padding: 20px;
    border: 1px solid #ddd;
    margin-top: 20px;
  }

  .invoice-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
  }

  .invoice-table th,
  .invoice-table td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: left;
  }

  .close-modal {
    position: absolute;
    right: 20px;
    top: 20px;
    cursor: pointer;
    font-size: 24px;
  }

  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--secondary);
    color: white;
    padding: 15px 25px;
    border-radius: 5px;
    animation: slideIn 0.3s ease-out;
    z-index: 1001;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
    }
    to {
      transform: translateX(0);
    }
  }

  .color-config {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }

  .color-config .form-group {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .color-config input[type="color"] {
    width: 100px;
    height: 40px;
    padding: 2px;
  }

  .patient-form {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }

  .patient-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  .patient-table th,
  .patient-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }

  .patient-table th {
    background: var(--primary);
    color: white;
  }

  .patient-table tr:hover {
    background: #f5f5f5;
  }

  textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 5px;
    min-height: 80px;
  }

  .switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
  }

  input:checked + .slider {
    background-color: var(--secondary);
  }

  input:checked + .slider:before {
    transform: translateX(26px);
  }

  .slider.round {
    border-radius: 34px;
  }

  .slider.round:before {
    border-radius: 50%;
  }

  .audits-panel {
    display: none;
  }

  .expenses-panel {
    display: none;
  }
</style>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div class="sidebar">
    <div class="logo">
      <img src="/Imagen1-removebg-preview.png" alt="Hiperbárica Morel Logo">
      <h2>Hiperbárica Morel</h2>
    </div>
    <div class="menu">
      <a href="#dashboard">Dashboard</a>
      <a href="#facturas">Facturas</a>
      <a href="#pacientes">Pacientes</a>
      <a href="#procedimientos">Procedimientos</a>
      <a href="#gastos">Gastos Generales</a>
      <a href="#auditorias">Auditorías</a>
      <a href="#reportes">Reportes</a>
      <a href="#configuracion">Configuración</a>
    </div>
  </div>

  <div class="main-content">
    <div class="header">
      <h1>Dashboard de Facturación</h1>
    </div>

    <div class="stats-container">
      <div class="stat-card">
        <h3>Ingresos Mensuales</h3>
        <h2>$0</h2>
        <p>0% vs mes anterior</p>
      </div>
      <div class="stat-card">
        <h3>Facturas</h3>
        <h2>0</h2>
        <p>0 vencidas</p>
      </div>
      <div class="stat-card">
        <h3>Pacientes Nuevos</h3>
        <h2>0</h2>
        <p>Este mes</p>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="revenueChart"></canvas>
    </div>

    <div class="chart-container">
      <canvas id="monthlyRevenueChart"></canvas>
    </div>

    <div class="invoice-form">
      <h2>Nueva Factura</h2>
      <form id="invoiceForm">
        <div class="form-group">
          <label>Paciente</label>
          <select id="patientSelect" required>
            <option value="">Seleccionar Paciente</option>
          </select>
        </div>
        <div class="form-group">
          <label>Procedimiento</label>
          <select id="procedureSelect" required>
            <option value="">Seleccionar Procedimiento</option>
          </select>
        </div>
        <div class="form-group">
          <label>Cantidad</label>
          <input type="number" id="procedureQuantity" min="1" value="1" required>
        </div>
        <div class="form-group">
          <label>Monto Total</label>
          <input type="number" id="totalAmount" readonly>
        </div>
        <button type="submit" class="btn">Generar Factura</button>
      </form>
    </div>

    <div class="patient-panel" style="display: none;">
      <div class="header">
        <h2>Registro de Pacientes</h2>
      </div>

      <div class="patient-form">
        <form id="patientForm">
          <div class="form-group">
            <label>ID de Paciente</label>
            <input type="text" id="patientAutoId" readonly>
          </div>
          <div class="form-group">
            <label>Nombre Completo</label>
            <input type="text" id="patientName" required>
          </div>
          <div class="form-group">
            <label>Fecha de Nacimiento</label>
            <input type="date" id="patientBirth" required>
          </div>
          <div class="form-group">
            <label>Edad</label>
            <input type="text" id="patientAge" readonly>
          </div>
          <div class="form-group">
            <label>Teléfono</label>
            <input type="tel" id="patientPhone" required>
          </div>
          <div class="form-group">
            <label>Correo Electrónico</label>
            <input type="email" id="patientEmail">
          </div>
          <div class="form-group">
            <label>Dirección</label>
            <textarea id="patientAddress"></textarea>
          </div>
          <div class="form-group">
            <label>Cédula</label>
            <input type="text" id="patientCedula" required>
          </div>
          <button type="submit" class="btn">Registrar Paciente</button>
        </form>
      </div>

      <div class="patient-list">
        <h3>Pacientes Registrados</h3>
        <input type="text" id="searchPatients" placeholder="Buscar en la tabla de pacientes...">
        <table class="patient-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Edad</th>
              <th>Teléfono</th>
              <th>Cédula</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="patientTableBody">
          </tbody>
        </table>
      </div>
    </div>

    <div class="procedures-panel" style="display: none;">
      <div class="header">
        <h2>Gestión de Procedimientos</h2>
      </div>

      <div class="patient-form">
        <form id="procedureForm">
          <div class="form-group">
            <label>ID de Procedimiento</label>
            <input type="text" id="procedureAutoId" readonly>
          </div>
          <div class="form-group">
            <label>Nombre del Procedimiento</label>
            <input type="text" id="procedureName" required>
          </div>
          <div class="form-group">
            <label>Precio</label>
            <input type="number" id="procedurePrice" required step="0.01" min="0">
          </div>
          <div class="form-group">
            <label>Descripción</label>
            <textarea id="procedureDescription"></textarea>
          </div>
          <button type="submit" class="btn">Registrar Procedimiento</button>
        </form>
      </div>

      <div class="patient-list">
        <h3>Procedimientos Registrados</h3>
        <input type="text" id="searchProcedures" placeholder="Buscar en la tabla de procedimientos...">
        <table class="patient-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Precio</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="procedureTableBody">
          </tbody>
        </table>
      </div>
    </div>

    <div class="invoices-panel" style="display: none;">
      <div class="header">
        <h2>Historial de Facturas</h2>
      </div>

      <div class="invoice-list">
        <input type="text" id="searchInvoices" placeholder="Buscar en la tabla de facturas...">
        <table class="patient-table">
          <thead>
            <tr>
              <th>Factura #</th>
              <th>Fecha</th>
              <th>Paciente</th>
              <th>Procedimiento</th>
              <th>Cantidad</th>
              <th>Total</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="invoiceTableBody">
          </tbody>
        </table>
      </div>
    </div>

    <div class="audits-panel" style="display: none;">
      <div class="header">
        <h2>Auditorías del Sistema</h2>
      </div>

      <div class="patient-list">
        <div class="form-group">
          <label>Filtrar por fecha:</label>
          <input type="date" id="auditDateFilter">
        </div>

        <table class="patient-table">
          <thead>
            <tr>
              <th>Fecha/Hora</th>
              <th>Usuario</th>
              <th>Acción</th>
              <th>Descripción</th>
              <th>Módulo</th>
            </tr>
          </thead>
          <tbody id="auditTableBody">
          </tbody>
        </table>
      </div>
    </div>

    <div class="expenses-panel" style="display: none;">
      <div class="header">
        <h2>Gastos Generales</h2>
      </div>

      <div class="patient-form">
        <form id="expenseForm">
          <div class="form-group">
            <label>ID de Gasto</label>
            <input type="text" id="expenseAutoId" readonly>
          </div>
          <div class="form-group">
            <label>Descripción del Material/Producto</label>
            <input type="text" id="expenseDescription" required>
          </div>
          <div class="form-group">
            <label>Cantidad</label>
            <input type="number" id="expenseQuantity" required min="1">
          </div>
          <div class="form-group">
            <label>Precio Unitario</label>
            <input type="number" id="expensePrice" required step="0.01" min="0">
          </div>
          <div class="form-group">
            <label>Total</label>
            <input type="number" id="expenseTotal" readonly>
          </div>
          <button type="submit" class="btn">Registrar Gasto</button>
        </form>
      </div>

      <div class="expenses-stats">
        <div class="stat-card">
          <h3>Total Gastos</h3>
          <h2 id="totalExpenses">$0.00</h2>
        </div>
        <div class="chart-container">
          <canvas id="expensesChart"></canvas>
        </div>
      </div>

      <div class="expenses-list">
        <h3>Lista de Gastos</h3>
        <input type="text" id="searchExpenses" placeholder="Buscar en la tabla de gastos...">
        <table class="patient-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Descripción</th>
              <th>Cantidad</th>
              <th>Precio Unit.</th>
              <th>Total</th>
              <th>Fecha</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="expensesTableBody">
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4" style="text-align: right"><strong>Total General:</strong></td>
              <td id="grandTotal" colspan="3"><strong>$0.00</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="configuration-panel" style="display: none;">
      <div class="header">
        <h2>Configuración</h2>
      </div>
      <div class="color-config">
        <h3>Personalización de Colores</h3>
        <div class="form-group">
          <label>Color Primario</label>
          <input type="color" id="primaryColor" value="#2C3E50">
        </div>
        <div class="form-group">
          <label>Color Secundario</label>
          <input type="color" id="secondaryColor" value="#3498DB">
        </div>
        <div class="form-group">
          <label>Color de Acento</label>
          <input type="color" id="accentColor" value="#E74C3C">
        </div>
        <div class="form-group">
          <label>Modo Oscuro</label>
          <label class="switch">
            <input type="checkbox" id="darkModeToggle">
            <span class="slider round"></span>
          </label>
        </div>
        <button class="btn" id="saveColors">Guardar Cambios</button>
      </div>
    </div>
  </div>

  <div class="modal" id="invoiceModal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2>Vista Previa de Factura</h2>
      <div class="invoice-preview">
        <h3>Hiperbárica Morel</h3>
        <p>Fecha: <span id="invoiceDate"></span></p>
        <p>Factura #: <span id="invoiceNumber"></span></p>
        <p>Paciente: <span id="invoicePatient"></span></p>

        <table class="invoice-table">
          <thead>
            <tr>
              <th>Procedimiento</th>
              <th>Cantidad</th>
              <th>Precio Unit.</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="invoiceItems">
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align: right"><strong>Total:</strong></td>
              <td id="invoiceTotal"></td>
            </tr>
          </tfoot>
        </table>
      </div>
      <button class="btn" id="confirmInvoice">Confirmar y Generar Factura</button>
    </div>
  </div>

<script>
let lastInvoiceNumber = 1000;
let lastPatientId = 1000; // Starting ID number
let lastProcedureId = 1000; // Starting procedure ID
let lastExpenseId = 1000; // Starting expense ID
const invoices = [];
const patients = [];
const procedures = [];
const expenses = [];
const auditLogs = [];
const patientPanel = document.querySelector('.patient-panel');
const procedurePanel = document.querySelector('.procedures-panel');
const invoiceLink = document.querySelector('a[href="#facturas"]');
const invoicesPanel = document.querySelector('.invoices-panel');
const expensesPanel = document.querySelector('.expenses-panel');

function initializeNewExpenseForm() {
    lastExpenseId++;
    document.getElementById('expenseAutoId').value = `EXP${lastExpenseId}`;
}

document.addEventListener('DOMContentLoaded', function() {
    const currentYear = new Date().getFullYear();
    const ctx = document.getElementById('revenueChart').getContext('2d');
    const revenueChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
            datasets: [{
                label: `Ingresos ${currentYear}`,
                data: Array(12).fill(0),
                borderColor: '#3498DB',
                tension: 0.4,
                fill: true,
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: `Ingresos Anuales ${currentYear}`,
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    const monthlyCtx = document.getElementById('monthlyRevenueChart').getContext('2d');
    const monthlyRevenueChart = new Chart(monthlyCtx, {
        type: 'bar',
        data: {
            labels: ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'],
            datasets: [{
                label: 'Ingresos Mensuales',
                data: Array(4).fill(0),
                backgroundColor: '#E74C3C'
            }],
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Ingresos Mensuales Detallados'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    function updateDashboardStats() {
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        const monthlyIncome = invoices
            .filter(inv => {
                const invDate = new Date(inv.date);
                return invDate.getMonth() === currentMonth && 
                       invDate.getFullYear() === currentYear;
            })
            .reduce((sum, inv) => sum + inv.amount, 0);

        const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
        const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
        const prevMonthIncome = invoices
            .filter(inv => {
                const invDate = new Date(inv.date);
                return invDate.getMonth() === prevMonth && 
                       invDate.getFullYear() === prevYear;
            })
            .reduce((sum, inv) => sum + inv.amount, 0);

        const percentageChange = prevMonthIncome === 0 ? 100 : 
            ((monthlyIncome - prevMonthIncome) / prevMonthIncome * 100).toFixed(1);

        const newPatients = patients.filter(patient => {
            const patientDate = new Date(patient.createdAt);
            return patientDate.getMonth() === currentMonth && 
                   patientDate.getFullYear() === currentYear;
        }).length;

        document.querySelector('.stat-card:nth-child(1) h2').textContent = 
            `$${monthlyIncome.toLocaleString()}`;
        document.querySelector('.stat-card:nth-child(1) p').textContent = 
            `${percentageChange}% vs mes anterior`;
        document.querySelector('.stat-card:nth-child(2) h2').textContent = 
            `${invoices.length}`;
        document.querySelector('.stat-card:nth-child(3) h2').textContent = 
            `${newPatients}`;
    }

    const invoiceForm = document.getElementById('invoiceForm');
    const modal = document.getElementById('invoiceModal');
    const closeModal = document.querySelector('.close-modal');
    const confirmInvoice = document.getElementById('confirmInvoice');
    const configLink = document.querySelector('a[href="#configuracion"]');
    const patientLink = document.querySelector('a[href="#pacientes"]');
    const procedureLink = document.querySelector('a[href="#procedimientos"]');
    const expensesLink = document.querySelector('a[href="#gastos"]');
    const mainSections = document.querySelectorAll('.main-content > div:not(.configuration-panel, .patient-panel, .procedures-panel, .audits-panel, .expenses-panel)');
    const configPanel = document.querySelector('.configuration-panel');
    const patientForm = document.getElementById('patientForm');
    const patientTableBody = document.getElementById('patientTableBody');
    const procedureForm = document.getElementById('procedureForm');
    const procedureTableBody = document.getElementById('procedureTableBody');
    const patientSelect = document.getElementById('patientSelect');
    const auditTableBody = document.getElementById('auditTableBody');

    function initializeNewPatientForm() {
        lastPatientId++;
        document.getElementById('patientAutoId').value = `PAC${lastPatientId}`;
    }

    function calculateAge(birthDate) {
        const today = new Date();
        const birth = new Date(birthDate);
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        
        return age;
    }

    document.getElementById('patientBirth').addEventListener('change', function(e) {
        const age = calculateAge(this.value);
        document.getElementById('patientAge').value = `${age} años`;
    });

    invoiceForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const patientId = this.querySelector('#patientSelect').value;
        const patientName = patients.find(patient => patient.id === patientId)?.name || '';
        const procedureId = document.getElementById('procedureSelect').value;
        const procedure = procedures.find(p => p.id === procedureId);
        const quantity = document.getElementById('procedureQuantity').value;
        const total = document.getElementById('totalAmount').value;

        if (!patientId || !procedureId || !quantity) {
            showNotification('Por favor complete todos los campos');
            return;
        }

        lastInvoiceNumber++;
        
        const currentDate = new Date().toLocaleDateString();
        document.getElementById('invoiceDate').textContent = currentDate;
        document.getElementById('invoiceNumber').textContent = lastInvoiceNumber;
        document.getElementById('invoicePatient').textContent = patientName;
        
        const itemsHtml = `
            <tr>
                <td>${procedure.name}</td>
                <td>${quantity}</td>
                <td>$${procedure.price.toFixed(2)}</td>
                <td>$${total}</td>
            </tr>
        `;
        document.getElementById('invoiceItems').innerHTML = itemsHtml;
        document.getElementById('invoiceTotal').textContent = `$${total}`;
        
        logAudit('Crear', `Factura #${lastInvoiceNumber} generada para ${patientName}`, 'Facturas');
        modal.style.display = 'block';
    });

    patientForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const patient = {
            id: document.getElementById('patientAutoId').value,
            name: document.getElementById('patientName').value.trim(),
            birth: document.getElementById('patientBirth').value,
            age: document.getElementById('patientAge').value,
            phone: document.getElementById('patientPhone').value,
            email: document.getElementById('patientEmail').value,
            address: document.getElementById('patientAddress').value,
            cedula: document.getElementById('patientCedula').value.trim(),
            createdAt: new Date()
        };
        
        patients.push(patient);
        updatePatientsTable();
        updatePatientSelect();
        updateDashboardStats();
        showNotification('Paciente registrado exitosamente');
        logAudit('Crear', `Paciente registrado: ${patient.name}`, 'Pacientes');
        this.reset();
        initializeNewPatientForm(); // Reset with new ID
    });

    function updateProcedureSelect() {
        const procedureSelect = document.getElementById('procedureSelect');
        procedureSelect.innerHTML = `
            <option value="">Seleccionar Procedimiento</option>
            ${procedures.map(proc => `
                <option value="${proc.id}" data-price="${proc.price}">${proc.name} - $${proc.price}</option>
            `).join('')}
        `;
    }

    procedureForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const procedure = {
            id: document.getElementById('procedureAutoId').value,
            name: document.getElementById('procedureName').value.trim(),
            price: parseFloat(document.getElementById('procedurePrice').value),
            description: document.getElementById('procedureDescription').value
        };
        
        procedures.push(procedure);
        updateProceduresTable();
        updateProcedureSelect();
        showNotification('Procedimiento registrado exitosamente');
        logAudit('Crear', `Procedimiento registrado: ${procedure.name}`, 'Procedimientos');
        this.reset();
        initializeNewProcedureForm(); // Reset with new ID
    });

    document.getElementById('procedureSelect').addEventListener('change', calculateTotal);
    document.getElementById('procedureQuantity').addEventListener('input', calculateTotal);

    function calculateTotal() {
        const procedureSelect = document.getElementById('procedureSelect');
        const quantity = document.getElementById('procedureQuantity').value;
        const selectedOption = procedureSelect.options[procedureSelect.selectedIndex];
        
        if (selectedOption && selectedOption.value) {
            const price = parseFloat(selectedOption.dataset.price);
            const total = price * quantity;
            document.getElementById('totalAmount').value = total.toFixed(2);
        } else {
            document.getElementById('totalAmount').value = '';
        }
    }

    window.editPatient = function(id) {
        const patient = patients.find(p => p.id === id);
        if (patient) {
            document.getElementById('patientAutoId').value = patient.id;
            document.getElementById('patientName').value = patient.name;
            document.getElementById('patientBirth').value = patient.birth;
            document.getElementById('patientAge').value = patient.age;
            document.getElementById('patientPhone').value = patient.phone;
            document.getElementById('patientEmail').value = patient.email;
            document.getElementById('patientAddress').value = patient.address;
            document.getElementById('patientCedula').value = patient.cedula;
        }
    }

    window.deletePatient = function(id) {
        const index = patients.findIndex(p => p.id === id);
        if (index > -1) {
            patients.splice(index, 1);
            updatePatientsTable();
            updatePatientSelect();
            showNotification('Paciente eliminado exitosamente');
            logAudit('Eliminar', `Paciente eliminado: ${id}`, 'Pacientes');
        }
    }

    function updatePatientsTable() {
        patientTableBody.innerHTML = patients.map(patient => `
            <tr>
              <td>${patient.id}</td>
              <td>${patient.name}</td>
              <td>${patient.age}</td>
              <td>${patient.phone}</td>
              <td>${patient.cedula}</td>
              <td>
                <button class="btn" onclick="editPatient('${patient.id}')">Editar</button>
                <button class="btn" style="background: var(--accent)" onclick="deletePatient('${patient.id}')">Eliminar</button>
              </td>
            </tr>
        `).join('');
    }

    window.editProcedure = function(id) {
        const procedure = procedures.find(p => p.id === id);
        if (procedure) {
            document.getElementById('procedureAutoId').value = procedure.id;
            document.getElementById('procedureName').value = procedure.name;
            document.getElementById('procedurePrice').value = procedure.price;
            document.getElementById('procedureDescription').value = procedure.description;
        }
    }

    window.deleteProcedure = function(id) {
        const index = procedures.findIndex(p => p.id === id);
        if (index > -1) {
            procedures.splice(index, 1);
            updateProceduresTable();
            updateProcedureSelect();
            showNotification('Procedimiento eliminado exitosamente');
            logAudit('Eliminar', `Procedimiento eliminado: ${id}`, 'Procedimientos');
        }
    }

    function updateProceduresTable() {
        procedureTableBody.innerHTML = procedures.map(proc => `
            <tr>
              <td>${proc.id}</td>
              <td>${proc.name}</td>
              <td>$${proc.price.toFixed(2)}</td>
              <td>
                <button class="btn" onclick="editProcedure('${proc.id}')">Editar</button>
                <button class="btn" style="background: var(--accent)" onclick="deleteProcedure('${proc.id}')">Eliminar</button>
              </td>
            </tr>
        `).join('');
    }

    function updatePatientSelect() {
        patientSelect.innerHTML = `
            <option value="">Seleccionar Paciente</option>
            ${patients.map(patient => `
                <option value="${patient.id}">${patient.name} - ${patient.id}</option>
            `).join('')}
        `;
    }

    function initializeNewProcedureForm() {
        lastProcedureId++;
        document.getElementById('procedureAutoId').value = `PROC${lastProcedureId}`;
    }

    function logAudit(action, description, module) {
        const auditEntry = {
            timestamp: new Date(),
            user: "Usuario Actual",
            action: action,
            description: description,
            module: module
        };
        auditLogs.push(auditEntry);
        updateAuditTable();
    }

    function updateAuditTable() {
        const dateFilter = document.getElementById('auditDateFilter')?.value;
        
        let filteredLogs = [...auditLogs];
        if (dateFilter) {
            filteredLogs = auditLogs.filter(log => 
                log.timestamp.toLocaleDateString() === new Date(dateFilter).toLocaleDateString()
            );
        }
        
        auditTableBody.innerHTML = filteredLogs.map(log => `
            <tr>
              <td>${log.timestamp.toLocaleString()}</td>
              <td>${log.user}</td>
              <td>${log.action}</td>
              <td>${log.description}</td>
              <td>${log.module}</td>
            </tr>
        `).join('');
    }

    closeModal.onclick = function() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    confirmInvoice.onclick = function() {
        const patientId = document.getElementById('patientSelect').value;
        const procedureId = document.getElementById('procedureSelect').value;
        const quantity = document.getElementById('procedureQuantity').value;
        const patient = patients.find(p => p.id === patientId);
        const procedure = procedures.find(p => p.id === procedureId);
        
        const invoice = {
            number: lastInvoiceNumber,
            date: new Date(),
            patientId: patientId,
            patient: patient.name,
            procedureId: procedureId,
            service: procedure.name,
            quantity: parseInt(quantity),
            amount: parseFloat(document.getElementById('invoiceTotal').textContent.replace('$', ''))
        };
        
        invoices.push(invoice);
        updateInvoicesTable();
        updateDashboardStats();
        generateInvoicePDF(invoice);
        
        showNotification('Factura generada y descargada exitosamente');
        modal.style.display = 'none';
        invoiceForm.reset();
    }

    window.regenerateInvoicePDF = function(invoiceNumber) {
        const invoice = invoices.find(inv => inv.number === invoiceNumber);
        if (invoice) {
            generateInvoicePDF(invoice);
        }
    };

    function generateInvoicePDF(invoice) {
        try {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                throw new Error('PDF library not loaded');
            }
            
            const doc = new jsPDF();
            
            const patientId = document.getElementById('patientSelect').value;
            const patient = patients.find(p => p.id === patientId);
            const procedureId = document.getElementById('procedureSelect').value;
            const procedure = procedures.find(p => p.id === procedureId);
            const quantity = document.getElementById('procedureQuantity').value;

            // Add logo
            try {
                doc.addImage('/Imagen1-removebg-preview.png', 'PNG', 20, 10, 40, 20);
            } catch (e) {
                console.warn('Logo could not be added to PDF:', e);
            }
            
            // Header with stylish design
            doc.setFillColor(44, 62, 80);
            doc.rect(0, 0, 210, 60, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text('Hiperbárica Morel', 70, 20);
            doc.setFontSize(14);
            doc.text(`FACTURA: #${invoice.number}`, 70, 40);
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.text(`Fecha: ${invoice.date.toLocaleDateString()}`, 20, 70);
            doc.text('DATOS DEL PACIENTE:', 20, 80);
            doc.text(`ID: ${patient.id}`, 20, 90);
            doc.text(`Nombre: ${patient.name}`, 20, 100);
            doc.text(`Edad: ${patient.age}`, 20, 110);
            doc.text(`Teléfono: ${patient.phone}`, 20, 120);
            doc.text(`Cédula: ${patient.cedula}`, 20, 130);

            // Invoice table
            const tableColumn = ["Procedimiento", "Cantidad", "Precio Unit.", "Total"];
            const tableRows = [[
                procedure.name,
                quantity,
                `$${procedure.price.toFixed(2)}`,
                `$${(procedure.price * quantity).toFixed(2)}`
            ]];
            
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 140,
                theme: 'striped',
                styles: {
                    fillColor: [245, 246, 251],
                    textColor: [44, 62, 80],
                    fontSize: 10
                },
                headStyles: {
                    fillColor: [44, 62, 80],
                    textColor: [255, 255, 255],
                    fontSize: 11
                }
            });
            
            const finalY = doc.lastAutoTable.finalY || 140;
            doc.setFillColor(52, 152, 219);
            doc.rect(0, finalY + 5, 210, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.text(`Total a Pagar: $${invoice.amount.toFixed(2)}`, 150, finalY + 18);
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.text('Gracias por su preferencia', 105, finalY + 35, { align: 'center' });
            
            doc.save(`factura-${invoice.number}.pdf`);
        } catch (error) {
            console.error('Error generating PDF:', error);
            showNotification('Error al generar la factura PDF');
        }
    }

    function updateInvoicesTable() {
        const invoiceTableBody = document.getElementById('invoiceTableBody');
        invoiceTableBody.innerHTML = invoices.map(invoice => {
            const patient = patients.find(p => p.id === invoice.patientId);
            const procedure = procedures.find(p => p.id === invoice.procedureId);
            
            return `
              <tr>
                <td>${invoice.number}</td>
                <td>${invoice.date.toLocaleDateString()}</td>
                <td>${patient ? patient.name : invoice.patient}</td>
                <td>${procedure ? procedure.name : invoice.service}</td>
                <td>${invoice.quantity}</td>
                <td>$${invoice.amount.toFixed(2)}</td>
                <td>
                  <button class="btn" onclick="regenerateInvoicePDF(${invoice.number})">
                    Descargar PDF
                  </button>
                </td>
              </tr>
            `;
        }).join('');
    }

    document.getElementById('darkModeToggle').addEventListener('change', function() {
        document.documentElement.setAttribute('data-theme', this.checked ? 'dark' : 'light');
    });

    function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    expensesLink.addEventListener('click', function(e) {
        e.preventDefault();
        mainSections.forEach(section => section.style.display = 'none');
        configPanel.style.display = 'none';
        patientPanel.style.display = 'none';
        procedurePanel.style.display = 'none';
        invoicesPanel.style.display = 'none';
        expensesPanel.style.display = 'block';
        
        initializeNewExpenseForm();
    });

    expenseForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const expense = {
            id: document.getElementById('expenseAutoId').value,
            description: document.getElementById('expenseDescription').value.trim(),
            quantity: parseInt(document.getElementById('expenseQuantity').value),
            price: parseFloat(document.getElementById('expensePrice').value),
            total: parseFloat(document.getElementById('expenseTotal').value),
            date: new Date()
        };
        
        expenses.push(expense);
        updateExpensesTable();
        updateExpensesStats();
        showNotification('Gasto registrado exitosamente');
        logAudit('Crear', `Gasto registrado: ${expense.description}`, 'Gastos');
        this.reset();
        initializeNewExpenseForm();
    });

    function updateExpensesTable() {
        const expensesTableBody = document.getElementById('expensesTableBody');
        expensesTableBody.innerHTML = expenses.map(expense => `
            <tr>
              <td>${expense.id}</td>
              <td>${expense.description}</td>
              <td>${expense.quantity}</td>
              <td>$${expense.price.toFixed(2)}</td>
              <td>$${expense.total.toFixed(2)}</td>
              <td>${expense.date.toLocaleDateString()}</td>
              <td>
                <button class="btn" onclick="editExpense('${expense.id}')">Editar</button>
                <button class="btn" style="background: var(--accent)" onclick="deleteExpense('${expense.id}')">Eliminar</button>
              </td>
            </tr>
        `).join('');

        const grandTotal = expenses.reduce((sum, exp) => sum + exp.total, 0);
        document.getElementById('grandTotal').innerHTML = `<strong>$${grandTotal.toFixed(2)}</strong>`;
    }

    function updateExpensesStats() {
        const totalExpenses = expenses.reduce((sum, exp) => sum + exp.total, 0);
        document.getElementById('totalExpenses').textContent = `$${totalExpenses.toFixed(2)}`;
        
        // Update chart
        const expensesByProduct = {};
        expenses.forEach(exp => {
            if (expensesByProduct[exp.description]) {
                expensesByProduct[exp.description] += exp.total;
            } else {
                expensesByProduct[exp.description] = exp.total;
            }
        });
        
        expensesChart.data.labels = Object.keys(expensesByProduct);
        expensesChart.data.datasets[0].data = Object.values(expensesByProduct);
        expensesChart.update();
    }

    // Add calculation for expense total
    document.getElementById('expenseQuantity').addEventListener('input', calculateExpenseTotal);
    document.getElementById('expensePrice').addEventListener('input', calculateExpenseTotal);

    function calculateExpenseTotal() {
        const quantity = document.getElementById('expenseQuantity').value;
        const price = document.getElementById('expensePrice').value;
        const total = quantity * price;
        document.getElementById('expenseTotal').value = total.toFixed(2);
    }

    document.querySelectorAll('.menu a').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const href = this.getAttribute('href');
            
            configPanel.style.display = 'none';
            patientPanel.style.display = 'none';
            procedurePanel.style.display = 'none';
            invoicesPanel.style.display = 'none';
            expensesPanel.style.display = 'none';
            document.querySelector('.audits-panel').style.display = 'none';
            mainSections.forEach(section => section.style.display = 'none');

            switch(href) {
                case '#dashboard':
                    mainSections.forEach(section => section.style.display = 'block');
                    configPanel.style.display = 'none';
                    patientPanel.style.display = 'none';
                    procedurePanel.style.display = 'none';
                    invoicesPanel.style.display = 'none';
                    expensesPanel.style.display = 'none';
                    document.querySelector('.audits-panel').style.display = 'none';
                    break;
                case '#configuracion':
                    configPanel.style.display = 'block';
                    break;
                case '#pacientes':
                    patientPanel.style.display = 'block';
                    break;
                case '#procedimientos':
                    procedurePanel.style.display = 'block';
                    break;
                case '#facturas':
                    invoicesPanel.style.display = 'block';
                    updateInvoicesTable();
                    break;
                case '#gastos':
                    expensesPanel.style.display = 'block';
                    initializeNewExpenseForm();
                    break;
                case '#auditorias':
                    document.querySelector('.audits-panel').style.display = 'block';
                    mainSections.forEach(section => section.style.display = 'none');
                    updateAuditTable();
                    break;
            }
        });
    });

    document.getElementById('auditDateFilter')?.addEventListener('change', updateAuditTable);
    
    updateDashboardStats(); 
    initializeNewPatientForm(); 
    initializeNewProcedureForm();
    initializeNewExpenseForm(); 
    const expensesCtx = document.getElementById('expensesChart').getContext('2d');
    const expensesChart = new Chart(expensesCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Gastos por Producto',
                data: [],
                backgroundColor: '#3498DB',
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    document.getElementById('searchPatients').addEventListener('input', function() {
        filterTable('patientTableBody', this.value.toLowerCase());
    });

    document.getElementById('searchInvoices').addEventListener('input', function() {
        filterTable('invoiceTableBody', this.value.toLowerCase());
    });

    document.getElementById('searchExpenses').addEventListener('input', function() {
        filterTable('expensesTableBody', this.value.toLowerCase());
    });

    function filterTable(tbodyId, query) {
        const tbody = document.getElementById(tbodyId);
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => {
            const cells = Array.from(row.querySelectorAll('td'));
            const match = cells.some(cell => cell.textContent.toLowerCase().includes(query));
            row.style.display = match ? '' : 'none';
        });
    }

    const primaryColorInput = document.getElementById('primaryColor');
    const secondaryColorInput = document.getElementById('secondaryColor');
    const accentColorInput = document.getElementById('accentColor');
    const saveColorsButton = document.getElementById('saveColors');

    function loadColors() {
        const primaryColor = localStorage.getItem('primaryColor');
        const secondaryColor = localStorage.getItem('secondaryColor');
        const accentColor = localStorage.getItem('accentColor');
        
        if (primaryColor) {
            primaryColorInput.value = primaryColor;
            document.documentElement.style.setProperty('--primary', primaryColor);
        }
        if (secondaryColor) {
            secondaryColorInput.value = secondaryColor;
            document.documentElement.style.setProperty('--secondary', secondaryColor);
        }
        if (accentColor) {
            accentColorInput.value = accentColor;
            document.documentElement.style.setProperty('--accent', accentColor);
        }
    }

    function saveColors() {
        const primaryColor = primaryColorInput.value;
        const secondaryColor = secondaryColorInput.value;
        const accentColor = accentColorInput.value;
        
        localStorage.setItem('primaryColor', primaryColor);
        localStorage.setItem('secondaryColor', secondaryColor);
        localStorage.setItem('accentColor', accentColor);
        
        document.documentElement.style.setProperty('--primary', primaryColor);
        document.documentElement.style.setProperty('--secondary', secondaryColor);
        document.documentElement.style.setProperty('--accent', accentColor);
    }

    saveColorsButton.addEventListener('click', function() {
        saveColors();
        showNotification('Colores guardados correctamente');
    });

    loadColors();
});

</script>

</body></html>